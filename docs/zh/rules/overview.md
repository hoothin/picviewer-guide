---
title: 规则总览
---

# 规则总览

规则系统负责将缩略图、懒加载图或内页图转换为"可下载的原图"。规则由多个字段组合，分为两种模式：

- JSON 模式：纯数据规则，安全、易维护。
- JS 模式：可写函数逻辑，适合复杂站点。

## 匹配流程

1. 依据 `url` 判断站点是否匹配（未写 `url` 视为全站）。
2. 依据 `src`、`r/s` 或 `getImage` 获取原图。
3. 若目标不是图片元素，使用 `ext` 或 `getExtSrc`。
4. 需要内页抓取时使用 `xhr`。
5. 返回结果交给浮动工具栏与画廊。

## 匹配优先级

同一站点命中多条规则时，按规则顺序执行。建议：

- 先写精确站点规则（`url` 限定）。
- 再写全局通用规则（`src` 或 `r/s`）。

## 返回值规则

- string：单图地址。
- array：多图地址。
- object：`{ url: [], cap: '' }` 形式用于同时返回图片与描述（常见于 `xhr`）。

## 常用字段

| 字段 | 作用 |
| --- | --- |
| `name` | 规则名称 |
| `url` | 站点匹配 |
| `src` | 图片匹配 |
| `r` / `s` | 替换规则 |
| `lazyAttr` | 懒加载字段 |
| `ext` | 邻近元素取图 |
| `getImage` | JS 逻辑获取图 |
| `getExtSrc` | 非图元素取图 |
| `xhr` | 内页抓取 |
| `clickToOpen` | 点击打开 |
| `exclude` | 排除规则 |

## 性能建议

- 能用 `r/s` 就不要用 `xhr`。
- `xhr` 只在必要时使用，并尽量限制 `url` 与选择器范围。
- 规则越精确，误命中越少，整体性能越稳。
